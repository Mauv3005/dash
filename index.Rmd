---
title: "Dashboard"
output: 
  flexdashboard::flex_dashboard:
    theme: cerulean
    orientation: columns
    vertical_layout: fill
    source_code: embed
---

```{r setup, include=FALSE}
library(flexdashboard)
library(dplyr)
library(leaflet)
library(ggplot2)
library(plotly)
library(chilemapas)
library(maps)
library(tmap)
library(sf)
library(viridis)
library(geojsonio)
library(readxl)

```

<style>
.tipo1{
  fill: #AC75D6; 
  stroke: #FFFFFF; 
  stroke-width: 10;
}

.tipo2:hover{
  transition: 1s fill; 
  fill: #000000;
}

.tipo3:hover{
  fill: #EAA81C; 
  transition: 1s fill; 
}
</style>

Ingresos, pobreza y seguridad (2017) {.storyboard}
===============================================
-----------------------------------------------------------------------

### Promedio de Ingresos (2017)

```{r fig.align='center'}
ESI17 <- read_xlsx("datos/Del_base2.xlsx",sheet=11)
colnames(ESI17)[1]<-"COMUNA"
colnames(ESI17)[2]<-"PROMEDIO"
colnames(ESI17)[3]<-"MEDIANA"
comunas_RM <- read_sf(dsn = "datos/limites_comunas_RM/RM.shp")
colnames(comunas_RM)[6]<-"COD_COMUNA"
colnames(comunas_RM)[7]<-"COMUNA"
ESI17<-mutate_if(ESI17, is.character, toupper)
data_RM11 <- comunas_RM %>% left_join(ESI17, by = "COMUNA")

paleta_colores <- colorNumeric(palette = "Reds", domain = comunas_RM$PROMEDIO)

data_RM11 %>% leaflet() %>%
  addPolygons(weight = 1, fillColor = ~paleta_colores(PROMEDIO), 
              fillOpacity = 1, 
              label = ~paste0(COMUNA,": $", round(PROMEDIO,1)),
              highlight = highlightOptions(weight = 5, 
                                           color = "orange",
                                           bringToFront = TRUE))%>%
  addPopups(-70.55, -33.4117, "Las Condes: $1377574",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.575, -33.3833, "Vitacura: $1835599",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.3686900, -33.2990800, "Lo Barnechea: $1485393",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.6917, -33.5167, "Lo Espejo: $327193",
    options = popupOptions(closeButton = T))%>%
  addPopups(-71.4558, -33.8944, "San Pedro: $340911",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.6417, -33.5333, "San Ramón: $369911",
    options = popupOptions(closeButton = T))
```

### Mediana de Ingresos (2017)

```{r fig.align='center'}
ESI17 <- read_xlsx("datos/Del_base2.xlsx",sheet=11)
colnames(ESI17)[1]<-"COMUNA"
colnames(ESI17)[2]<-"PROMEDIO"
colnames(ESI17)[3]<-"MEDIANA"
comunas_RM <- read_sf(dsn = "datos/limites_comunas_RM/RM.shp")
colnames(comunas_RM)[6]<-"COD_COMUNA"
colnames(comunas_RM)[7]<-"COMUNA"
ESI17<-mutate_if(ESI17, is.character, toupper)
data_RM11 <- comunas_RM %>% left_join(ESI17, by = "COMUNA")

paleta_colores <- colorNumeric(palette = "Reds", domain = comunas_RM$MEDIANA)

data_RM11 %>% leaflet() %>%
  addPolygons(weight = 1, fillColor = ~paleta_colores(MEDIANA), 
              fillOpacity = 1, 
              label = ~paste0(COMUNA,": $", round(MEDIANA,1)),
              highlight = highlightOptions(weight = 5, 
                                           color = "orange",
                                           bringToFront = TRUE))%>%
  addPopups(-70.6, -33.4583, "Ñuñoa: $927943",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.575, -33.3833, "Vitacura: $1127354",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.60454, -33.43107, "Providencia: $1000000",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.6917, -33.5167, "Lo Espejo: $300000",
    options = popupOptions(closeButton = T))%>%
  addPopups(-71.4558, -33.8944, "San Pedro: $319725",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.7167, -33.5, "Cerrillos: $320000",
    options = popupOptions(closeButton = T))

```

### Número de personas en situación de pobreza por ingresos (2017)

```{r fig.align='center'}
Pobreza17 <- read_xlsx("datos/Del_base2.xlsx",sheet=8)
Pobreza17<-mutate_if(Pobreza17, is.character, toupper)
colnames(Pobreza17)[1]<-"COMUNA"
colnames(Pobreza17)[2]<-"Personas"
colnames(Pobreza17)[3]<-"Porcentaje"
data_RM8 <- comunas_RM %>% left_join(Pobreza17, by = "COMUNA")

paleta_colores <- colorNumeric(palette = "Reds", domain = comunas_RM$Personas)

data_RM8 %>% leaflet() %>%
  addPolygons(weight = 1, fillColor = ~paleta_colores(Personas), 
              fillOpacity = 1, 
              label = ~paste0(COMUNA,": ", round(Personas,1)),
              highlight = highlightOptions(weight = 5, 
                                           color = "orange",
                                           bringToFront = TRUE))%>%
  addPopups(-70.575, -33.3833, "Vitacura: 99",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.60454, -33.43107, "Providencia: 513",
    options = popupOptions(closeButton = T))%>%
  addPopups(-71.1164, -34.0278, "Alhué: 303",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.57577, -33.61169, "Puente Alto: 63255",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.7, -33.5833, "San Bernardo: 31280",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.7667, -33.5167, "Maipú: 28806",
    options = popupOptions(closeButton = T))
```

### Porcentaje de personas en situación de pobreza por ingresos (2017)

```{r fig.align='center'}
Pobreza17 <- read_xlsx("datos/Del_base2.xlsx",sheet=8)
Pobreza17<-mutate_if(Pobreza17, is.character, toupper)
colnames(Pobreza17)[1]<-"COMUNA"
colnames(Pobreza17)[2]<-"Personas"
colnames(Pobreza17)[3]<-"Porcentaje"
data_RM8 <- comunas_RM %>% left_join(Pobreza17, by = "COMUNA")

paleta_colores <- colorNumeric(palette = "Reds", domain = comunas_RM$Porcentaje)

data_RM8 %>% leaflet() %>%
  addPolygons(weight = 1, fillColor = ~paleta_colores(Porcentaje), 
              fillOpacity = 1, 
              label = ~paste0(COMUNA,": ", round(Porcentaje,4)*100,"%"),
              highlight = highlightOptions(weight = 5, 
                                           color = "orange",
                                           bringToFront = TRUE))%>%
  addPopups(-70.575, -33.3833, "Vitacura: 0,1%",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.55, -33.4117, "Las Condes: 0,2%",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.60454, -33.43107, "Providencia: 0,4%",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.63419, -33.58331, "La Pintana: 14,1%",
    options = popupOptions(closeButton = T))%>%
  addPopups(-71.1167, -33.5167, "María Pinto: 10,8%",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.675, -33.5667, "El Bosque: 9,6%",
    options = popupOptions(closeButton = T))
```

### Número de guardias, inspectores o vigilantes municipales (2017)

```{r fig.align='center'}
Municipio <- read_xlsx("datos/Del_base2.xlsx",sheet=7)
comunas_RM <- read_sf(dsn = "datos/limites_comunas_RM/RM.shp")
colnames(comunas_RM)[6]<-"COD_COMUNA"
colnames(comunas_RM)[7]<-"COMUNA"
colnames(Municipio)[1]<-"COMUNA"
data_RM7 <- comunas_RM %>% left_join(Municipio, by = "COMUNA")
data_RM7$a2017 = as.numeric(gsub("[[:punct:]]", "", data_RM7$a2017))
data_RM7$a2020 = as.numeric(gsub("[[:punct:]]", "", data_RM7$a2020))

paleta_colores <- colorNumeric(palette = "Reds", domain = comunas_RM$a2017)

data_RM7 %>% leaflet() %>%
  addPolygons(weight = 1, fillColor = ~paleta_colores(a2017), 
              fillOpacity = 1, 
              label = ~paste0(COMUNA,": ", round(a2017,1)),
              highlight = highlightOptions(weight = 5, 
                                           color = "orange",
                                           bringToFront = TRUE))%>%
  addPopups(-70.7667, -33.5167, "Maipú: 406",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.55, -33.4117, "Las Condes: 281",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.7, -33.4667, "Huechuraba: 170",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.6917, -33.5167, "Lo Espejo: 0",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.7167, -33.4033, "Renca: 0",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.6333, -33.4083, "Recoleta: 0",
    options = popupOptions(closeButton = T))
```

***

El potencial de crecimiento en región 1 es...


















Comercio Ambulante {data-navmenu=Delito_2017}
===============================================

Column {data-width=600}
-----------------------------------------------------------------------

### Frecuencia (2017)

```{r fig.align='center'}
Comercio_Ambulante <- read_xlsx("datos/Del_base2.xlsx",sheet=1)
comunas_RM <- read_sf(dsn = "datos/limites_comunas_RM/RM.shp")
colnames(comunas_RM)[6]<-"COD_COMUNA"
colnames(comunas_RM)[7]<-"COMUNA"
data_RM <- comunas_RM %>% left_join(Comercio_Ambulante, by = "COMUNA")

paleta_colores <- colorNumeric(palette = "Reds", domain = comunas_RM$a2017)

data_RM %>% leaflet() %>%
  addPolygons(weight = 1, fillColor = ~paleta_colores(a2017), 
              fillOpacity = 1, 
              label = ~paste0(COMUNA,": ", round(a2017,1)),
              highlight = highlightOptions(weight = 5, 
                                           color = "orange",
                                           bringToFront = TRUE))%>%
  addPopups(-70.60454, -33.43107, "Providencia: 3859",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.7, -33.4667, "Estación Central: 6164",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.6653, -33.4513, "Santiago: 18359",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.55, -33.4117, "Las Condes: 319",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.575, -33.3833, "Vitacura: 105",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.3686900, -33.2990800, "Lo Barnechea: 7",
    options = popupOptions(closeButton = T))
```

Column {data-width=400}
-----------------------------------------------------------------------

> Nota: El número de personas capacitadas está actualizado al 10 de Mayo del 2021.



Homicidio {data-navmenu=Delito_2017}
===============================================

Column {data-width=600}
-----------------------------------------------------------------------

### Frecuencia (2017)

```{r fig.align='center'}
Homicidio <- read_xlsx("datos/Del_base2.xlsx",sheet=2)
comunas_RM <- read_sf(dsn = "datos/limites_comunas_RM/RM.shp")
colnames(comunas_RM)[6]<-"COD_COMUNA"
colnames(comunas_RM)[7]<-"COMUNA"
data_RM2 <- comunas_RM %>% left_join(Homicidio, by = "COMUNA")

paleta_colores <- colorNumeric(palette = "Reds", domain = comunas_RM$a2017)

data_RM2 %>% leaflet() %>%
  addPolygons(weight = 1, fillColor = ~paleta_colores(a2017), 
              fillOpacity = 1, 
              label = ~paste0(COMUNA,": ", round(a2017,1)),
              highlight = highlightOptions(weight = 5, 
                                           color = "orange",
                                           bringToFront = TRUE))%>%
  addPopups(-70.6333, -33.4083, "Recoleta: 24",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.6653, -33.4513, "Santiago: 21",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.57577, -33.61169, "Puente Alto: 21",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.7, -33.4667, "Estación Central: 22",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.55, -33.4117, "Las Condes: 0",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.575, -33.3833, "Vitacura: 0",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.3686900, -33.2990800, "Lo Barnechea: 1",
    options = popupOptions(closeButton = T))
```


Column {data-width=400}
-----------------------------------------------------------------------

> Nota: El número de personas capacitadas está actualizado al 10 de Mayo del 2021.



Hurto {data-navmenu=Delito_2017}
===============================================

Column {data-width=600}
-----------------------------------------------------------------------

### Frecuencia (2017)

```{r fig.align='center'}
Hurto <- read_xlsx("datos/Del_base2.xlsx",sheet=3)
comunas_RM <- read_sf(dsn = "datos/limites_comunas_RM/RM.shp")
colnames(comunas_RM)[6]<-"COD_COMUNA"
colnames(comunas_RM)[7]<-"COMUNA"
data_RM3 <- comunas_RM %>% left_join(Hurto, by = "COMUNA")

paleta_colores <- colorNumeric(palette = "Reds", domain = comunas_RM$a2017)

data_RM3 %>% leaflet() %>%
  addPolygons(weight = 1, fillColor = ~paleta_colores(a2017), 
              fillOpacity = 1, 
              label = ~paste0(COMUNA,": ", round(a2017,1)),
              highlight = highlightOptions(weight = 5, 
                                           color = "orange",
                                           bringToFront = TRUE))%>%
  addPopups(-70.6653, -33.4513, "Santiago: 10073",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.60454, -33.43107, "Providencia: 6182",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.5833, -33.5333, "La Florida: 5407",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.55, -33.4117, "Las Condes: 4202",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.575, -33.3833, "Vitacura: 831",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.3686900, -33.2990800, "Lo Barnechea: 979",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.7667, -33.5167, "Maipú: 3003",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.57577, -33.61169, "Puente Alto: 3827",
    options = popupOptions(closeButton = T))
```


Column {data-width=400}
-----------------------------------------------------------------------

> Nota: El número de personas capacitadas está actualizado al 10 de Mayo del 2021.



Robo con violencia o intimidación {data-navmenu=Delito_2017}
===============================================

Column {data-width=600}
-----------------------------------------------------------------------

### Frecuencia (2017)

```{r fig.align='center'}
Robo_Violencia <- read_xlsx("datos/Del_base2.xlsx",sheet=4)
comunas_RM <- read_sf(dsn = "datos/limites_comunas_RM/RM.shp")
colnames(comunas_RM)[6]<-"COD_COMUNA"
colnames(comunas_RM)[7]<-"COMUNA"
data_RM4 <- comunas_RM %>% left_join(Robo_Violencia, by = "COMUNA")

paleta_colores <- colorNumeric(palette = "Reds", domain = comunas_RM$a2017)

data_RM4 %>% leaflet() %>%
  addPolygons(weight = 1, fillColor = ~paleta_colores(a2017), 
              fillOpacity = 1, 
              label = ~paste0(COMUNA,": ", round(a2017,1)),
              highlight = highlightOptions(weight = 5, 
                                           color = "orange",
                                           bringToFront = TRUE))%>%
  addPopups(-70.6653, -33.4513, "Santiago: 5373",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.57577, -33.61169, "Puente Alto: 3619",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.7, -33.5833, "San Bernardo: 2616",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.60454, -33.43107, "Providencia: 1546",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.55, -33.4117, "Las Condes: 826",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.575, -33.3833, "Vitacura: 595",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.3686900, -33.2990800, "Lo Barnechea: 232",
    options = popupOptions(closeButton = T))
```


Column {data-width=400}
-----------------------------------------------------------------------

> Nota: El número de personas capacitadas está actualizado al 10 de Mayo del 2021.


Robo con sorpresa {data-navmenu=Delito_2017}
===============================================

Column {data-width=600}
-----------------------------------------------------------------------

### Frecuencia (2017)

```{r fig.align='center'}
Robo_sorpresa <- read_xlsx("datos/Del_base2.xlsx",sheet=5)
comunas_RM <- read_sf(dsn = "datos/limites_comunas_RM/RM.shp")
colnames(comunas_RM)[6]<-"COD_COMUNA"
colnames(comunas_RM)[7]<-"COMUNA"
data_RM5 <- comunas_RM %>% left_join(Robo_sorpresa, by = "COMUNA")

paleta_colores <- colorNumeric(palette = "Reds", domain = comunas_RM$a2017)

data_RM5 %>% leaflet() %>%
  addPolygons(weight = 1, fillColor = ~paleta_colores(a2017), 
              fillOpacity = 1, 
              label = ~paste0(COMUNA,": ", round(a2017,1)),
              highlight = highlightOptions(weight = 5, 
                                           color = "orange",
                                           bringToFront = TRUE))%>%
  addPopups(-70.6653, -33.4513, "Santiago: 4455",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.57577, -33.61169, "Puente Alto: 1108",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.60454, -33.43107, "Providencia: 1358",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.55, -33.4117, "Las Condes: 430",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.575, -33.3833, "Vitacura: 103",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.3686900, -33.2990800, "Lo Barnechea: 45",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.7, -33.4667, "Estación Central: 1141",
    options = popupOptions(closeButton = T))
```


Column {data-width=400}
-----------------------------------------------------------------------

> Nota: El número de personas capacitadas está actualizado al 10 de Mayo del 2021.


Violencia intrafamiliar {data-navmenu=Delito_2017}
===============================================

Column {data-width=600}
-----------------------------------------------------------------------

### Frecuencia (2017)

```{r fig.align='center'}
Violencia <- read_xlsx("datos/Del_base2.xlsx",sheet=6)
comunas_RM <- read_sf(dsn = "datos/limites_comunas_RM/RM.shp")
colnames(comunas_RM)[6]<-"COD_COMUNA"
colnames(comunas_RM)[7]<-"COMUNA"
data_RM6 <- comunas_RM %>% left_join(Violencia, by = "COMUNA")

paleta_colores <- colorNumeric(palette = "Reds", domain = comunas_RM$a2017)

data_RM6 %>% leaflet() %>%
  addPolygons(weight = 1, fillColor = ~paleta_colores(a2017), 
              fillOpacity = 1, 
              label = ~paste0(COMUNA,": ", round(a2017,1)),
              highlight = highlightOptions(weight = 5, 
                                           color = "orange",
                                           bringToFront = TRUE))%>%
  addPopups(-70.57577, -33.61169, "Puente Alto: 4466",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.7667, -33.5167, "Maipú: 2950",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.7, -33.5833, "San Bernardo: 2275",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.55, -33.4117, "Las Condes: 665",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.575, -33.3833, "Vitacura: 167",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.3686900, -33.2990800, "Lo Barnechea: 361",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.6653, -33.4513, "Santiago: 2183",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.5833, -33.5333, "La Florida: 2209",
    options = popupOptions(closeButton = T))
```


Column {data-width=400}
-----------------------------------------------------------------------

> Nota: El número de personas capacitadas está actualizado al 10 de Mayo del 2021.


Evolución de delitos a través del tiempo
===============================================
Column {.tabset}
-----------------------------------------------------------------------

### Anual (2017 a 2020)

```{r fig.align='center'}
Graph <- read_xlsx("datos/Base _grafico.xlsx",sheet=2)
colnames(Graph)[1]<-"DELITO"

g2<-Graph %>%
  ggplot(aes(x = Año, y = Casos)) +
  geom_line(aes(color = DELITO), size=1.1)+
  scale_x_continuous(breaks = seq(2017, 2020, 1),
                     labels = seq(2017, 2020, 1))+
  scale_y_continuous(breaks = seq(250, 70000, 10000),
                     labels = seq(250, 70000, 10000))+
  scale_color_brewer(name = NULL, type = "qual", palette = "Dark2")+
  labs(title = "Evolución de distintos delitos a través del tiempo",
       subtitle = "2017-2020",
       caption = "Fuente: Elaboración propia en base a estadísticas del CEAD",
       x = NULL,
       y = "Frecuencia del delito") +
  theme_minimal() +
  theme(legend.position = c(0.9, 0.2))

ggplotly(g2)
```

### Trimestral (2017 a 2020)

```{r fig.align='center'}
Graph2 <- read_xlsx("datos/Base _grafico.xlsx",sheet=3)
colnames(Graph2)[1]<-"DELITO"

g3<-Graph2 %>%
  ggplot(aes(x = Trimestre, y = Casos)) +
  geom_line(aes(color = DELITO), size=1.1)+
  scale_x_discrete(breaks = seq(2017, 2020, 1),
                     labels = seq(2017, 2020, 1))+
  scale_y_continuous(breaks = seq(50, 20000, 4000),
                     labels = seq(50, 20000, 4000))+
  scale_color_brewer(name = NULL, type = "qual", palette = "Dark2")+
  labs(title = "Evolución de distintos delitos a través del tiempo",
       subtitle = "2017-2020",
       caption = "Fuente: Elaboración propia en base a estadísticas del CEAD",
       x = NULL,
       y = "Frecuencia del delito") +
  theme_minimal() +
  theme(legend.position = c(0.9, 0.2))

ggplotly(g3)
```


### Mensual (2017 a 2020)

```{r fig.align='center'}
Graph3 <- read_xlsx("datos/Base _grafico.xlsx",sheet=4)
colnames(Graph3)[1]<-"DELITO"

g4<-Graph3 %>%
  ggplot(aes(x = Mes, y = Casos)) +
  geom_line(aes(color = DELITO), size=1.1)+
  scale_x_discrete(breaks = seq(2017, 2020, 1),
                     labels = seq(2017, 2020, 1))+
  scale_y_continuous(breaks = seq(10, 7000, 1000),
                     labels = seq(10, 7000, 1000))+
  scale_color_brewer(name = NULL, type = "qual", palette = "Dark2")+
  labs(title = "Evolución de distintos delitos a través del tiempo",
       subtitle = "2017-2020",
       caption = "Fuente: Elaboración propia en base a estadísticas del CEAD",
       x = NULL,
       y = "Frecuencia del delito") +
  theme_minimal() +
  theme(legend.position = c(0.9, 0.2))

ggplotly(g4)
```


Ingresos, pobreza y seguridad (2020) {.storyboard}
===============================================
-----------------------------------------------------------------------

### Promedio de Ingresos (2020)

```{r fig.align='center'}
ESI20 <- read_xlsx("datos/Del_base2.xlsx",sheet=10)
colnames(ESI20)[1]<-"COMUNA"
colnames(ESI20)[2]<-"PROMEDIO"
colnames(ESI20)[3]<-"MEDIANA"
comunas_RM <- read_sf(dsn = "datos/limites_comunas_RM/RM.shp")
colnames(comunas_RM)[6]<-"COD_COMUNA"
colnames(comunas_RM)[7]<-"COMUNA"
ESI20<-mutate_if(ESI20, is.character, toupper)
data_RM10 <- comunas_RM %>% left_join(ESI20, by = "COMUNA")

paleta_colores <- colorNumeric(palette = "Reds", domain = comunas_RM$PROMEDIO)

data_RM10 %>% leaflet() %>%
  addPolygons(weight = 1, fillColor = ~paleta_colores(PROMEDIO), 
              fillOpacity = 1, 
              label = ~paste0(COMUNA,": $", round(PROMEDIO,1)),
              highlight = highlightOptions(weight = 5, 
                                           color = "orange",
                                           bringToFront = TRUE))%>%
  addPopups(-70.60454, -33.43107, "Providencia: $1842269",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.575, -33.3833, "Vitacura: $1661992",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.55, -33.4117, "Las Condes: $1545689",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.6, -33.4583, "Ñuñoa: $1299785",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.75, -33.8167, "Paine: $338655",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.625, -33.5333, "La Granja: $355405",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.6917, -33.5167, "Lo Espejo: $355661",
    options = popupOptions(closeButton = T))
```

### Mediana de Ingresos (2020)

```{r fig.align='center'}
ESI20 <- read_xlsx("datos/Del_base2.xlsx",sheet=10)
colnames(ESI20)[1]<-"COMUNA"
colnames(ESI20)[2]<-"PROMEDIO"
colnames(ESI20)[3]<-"MEDIANA"
comunas_RM <- read_sf(dsn = "datos/limites_comunas_RM/RM.shp")
colnames(comunas_RM)[6]<-"COD_COMUNA"
colnames(comunas_RM)[7]<-"COMUNA"
ESI20<-mutate_if(ESI20, is.character, toupper)
data_RM10 <- comunas_RM %>% left_join(ESI20, by = "COMUNA")

paleta_colores <- colorNumeric(palette = "Reds", domain = comunas_RM$MEDIANA)

data_RM10 %>% leaflet() %>%
  addPolygons(weight = 1, fillColor = ~paleta_colores(MEDIANA), 
              fillOpacity = 1, 
              label = ~paste0(COMUNA,": $", round(MEDIANA,1)),
              highlight = highlightOptions(weight = 5, 
                                           color = "orange",
                                           bringToFront = TRUE))%>%
  addPopups(-70.60454, -33.43107, "Providencia: $1400000",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.575, -33.3833, "Vitacura: $1200000",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.6, -33.4583, "Ñuñoa: $1001316",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.55, -33.4117, "Las Condes: $1001316",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.625, -33.5333, "La Granja: $302042",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.75, -33.8167, "Paine: $330434",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.63419, -33.58331, "La Pintana: $340000",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.6917, -33.5167, "Lo Espejo: $352382",
    options = popupOptions(closeButton = T))
```

### Número de personas en situación de pobreza por ingresos (2020)

```{r fig.align='center'}
Pobreza20 <- read_xlsx("datos/Del_base2.xlsx",sheet=9)
Pobreza20<-mutate_if(Pobreza20, is.character, toupper)
colnames(Pobreza20)[1]<-"COMUNA"
colnames(Pobreza20)[2]<-"Personas"
colnames(Pobreza20)[3]<-"Porcentaje"
data_RM9 <- comunas_RM %>% left_join(Pobreza20, by = "COMUNA")

paleta_colores <- colorNumeric(palette = "Reds", domain = comunas_RM$Personas)

data_RM9 %>% leaflet() %>%
  addPolygons(weight = 1, fillColor = ~paleta_colores(Personas), 
              fillOpacity = 1, 
              label = ~paste0(COMUNA,": ", round(Personas,1)),
              highlight = highlightOptions(weight = 5, 
                                           color = "orange",
                                           bringToFront = TRUE))%>%
  addPopups(-71.1164, -34.0278, "Alhué: 537",
    options = popupOptions(closeButton = T))%>%
  addPopups(-71.1167, -33.5167, "María Pinto: 1544",
    options = popupOptions(closeButton = T))%>%
  addPopups(-71.4558, -33.8944, "San Pedro: 1594",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.60454, -33.43107, "Providencia: 5778",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.575, -33.3833, "Vitacura: 3240",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.55, -33.4117, "Las Condes: 9269",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.57577, -33.61169, "Puente Alto: 51880",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.7667, -33.5167, "Maipú: 40907",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.7, -33.5833, "San Bernardo: 35937",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.3686900, -33.2990800, "Lo Barnechea: 6891",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.6653, -33.4513, "Santiago: 42878",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.5833, -33.5333, "La Florida: 32433",
    options = popupOptions(closeButton = T))
```

### Porcentaje de personas en situación de pobreza por ingresos (2020)

```{r fig.align='center'}
Pobreza20 <- read_xlsx("datos/Del_base2.xlsx",sheet=9)
Pobreza20<-mutate_if(Pobreza17, is.character, toupper)
colnames(Pobreza20)[1]<-"COMUNA"
colnames(Pobreza20)[2]<-"Personas"
colnames(Pobreza20)[3]<-"Porcentaje"
data_RM9 <- comunas_RM %>% left_join(Pobreza20, by = "COMUNA")

paleta_colores <- colorNumeric(palette = "Reds", domain = comunas_RM$Porcentaje)

data_RM9 %>% leaflet() %>%
  addPolygons(weight = 1, fillColor = ~paleta_colores(Porcentaje), 
              fillOpacity = 1, 
              label = ~paste0(COMUNA,": ", round(Porcentaje,4)*100,"%"),
              highlight = highlightOptions(weight = 5, 
                                           color = "orange",
                                           bringToFront = TRUE))%>%
  addPopups(-70.575, -33.3833, "Vitacura: 3,33%",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.55, -33.4117, "Las Condes: 2,79%",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.60454, -33.43107, "Providencia: 3,64%",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.3686900, -33.2990800, "Lo Barnechea: 5,50%",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.6917, -33.5167, "Lo Espejo: 14,39%",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.6667, -33.4167, "Independencia: 13,93%",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.63419, -33.58331, "La Pintana: 15,31%",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.725, -33.45, "Lo Prado: 13,72%",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.6333, -33.4083, "Recoleta: 13,24%",
    options = popupOptions(closeButton = T))
```

### Número de guardias, inspectores o vigilantes municipales (2020)

```{r fig.align='center'}
Municipio <- read_xlsx("datos/Del_base2.xlsx",sheet=7)
comunas_RM <- read_sf(dsn = "datos/limites_comunas_RM/RM.shp")
colnames(comunas_RM)[6]<-"COD_COMUNA"
colnames(comunas_RM)[7]<-"COMUNA"
colnames(Municipio)[1]<-"COMUNA"
data_RM7 <- comunas_RM %>% left_join(Municipio, by = "COMUNA")
data_RM7$a2017 = as.numeric(gsub("[[:punct:]]", "", data_RM7$a2017))
data_RM7$a2020 = as.numeric(gsub("[[:punct:]]", "", data_RM7$a2020))

paleta_colores <- colorNumeric(palette = "Reds", domain = comunas_RM$a2020)

data_RM7 %>% leaflet() %>%
  addPolygons(weight = 1, fillColor = ~paleta_colores(a2020), 
              fillOpacity = 1, 
              label = ~paste0(COMUNA,": ", round(a2020,1)),
              highlight = highlightOptions(weight = 5, 
                                           color = "orange",
                                           bringToFront = TRUE))%>%
  addPopups(-70.7667, -33.5167, "Maipú: 736",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.55, -33.4117, "Las Condes: 146",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.6917, -33.5167, "Lo Espejo: 0",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.7167, -33.4033, "Renca: 18",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.6333, -33.4083, "Recoleta: 0",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.60454, -33.43107, "Providencia: 259",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.3686900, -33.2990800, "Lo Barnechea: 237",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.575, -33.3833, "Vitacura: 155",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.7333, -33.3667, "Quilicura: 228",
    options = popupOptions(closeButton = T))
```

***

El potencial de crecimiento en región 1 es...









Comercio Ambulante {data-navmenu=Delito_2020}
===============================================

Column {data-width=600}
-----------------------------------------------------------------------

### Frecuencia (2020)

```{r fig.align='center'}
Comercio_Ambulante <- read_xlsx("datos/Del_base2.xlsx",sheet=1)
comunas_RM <- read_sf(dsn = "datos/limites_comunas_RM/RM.shp")
colnames(comunas_RM)[6]<-"COD_COMUNA"
colnames(comunas_RM)[7]<-"COMUNA"
data_RM <- comunas_RM %>% left_join(Comercio_Ambulante, by = "COMUNA")

paleta_colores <- colorNumeric(palette = "Reds", domain = comunas_RM$a2020)

data_RM %>% leaflet() %>%
  addPolygons(weight = 1, fillColor = ~paleta_colores(a2020), 
              fillOpacity = 1, 
              label = ~paste0(COMUNA,": ", round(a2020,1)),
              highlight = highlightOptions(weight = 5, 
                                           color = "orange",
                                           bringToFront = TRUE))%>%
  addPopups(-70.6653, -33.4513, "Santiago: 1347",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.7, -33.4667, "Estación Central: 346",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.60454, -33.43107, "Providencia: 345",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.55, -33.4117, "Las Condes: 15",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.575, -33.3833, "Vitacura: 0",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.3686900, -33.2990800, "Lo Barnechea: 7",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.57577, -33.61169, "Puente Alto: 271",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.7667, -33.5167, "Maipú: 153",
    options = popupOptions(closeButton = T))
```

Column {data-width=400}
-----------------------------------------------------------------------

> Nota: hdhdhdhdhdhdhdhdhdhhhh



Homicidio {data-navmenu=Delito_2020}
===============================================

Column {data-width=600}
-----------------------------------------------------------------------

### Frecuencia (2020)

```{r fig.align='center'}
Homicidio <- read_xlsx("datos/Del_base2.xlsx",sheet=2)
comunas_RM <- read_sf(dsn = "datos/limites_comunas_RM/RM.shp")
colnames(comunas_RM)[6]<-"COD_COMUNA"
colnames(comunas_RM)[7]<-"COMUNA"
data_RM2 <- comunas_RM %>% left_join(Homicidio, by = "COMUNA")

paleta_colores <- colorNumeric(palette = "Reds", domain = comunas_RM$a2020)

data_RM2 %>% leaflet() %>%
  addPolygons(weight = 1, fillColor = ~paleta_colores(a2020), 
              fillOpacity = 1, 
              label = ~paste0(COMUNA,": ", round(a2020,1)),
              highlight = highlightOptions(weight = 5, 
                                           color = "orange",
                                           bringToFront = TRUE))%>%
  addPopups(-70.63419, -33.58331, "La Pintana: 39%",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.6653, -33.4513, "Santiago: 33",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.57577, -33.61169, "Puente Alto: 25",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.7, -33.4667, "Estación Central: 14",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.7667, -33.5167, "Maipú: 25",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.55, -33.4117, "Las Condes: 3",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.575, -33.3833, "Vitacura: 0",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.3686900, -33.2990800, "Lo Barnechea: 2",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.60454, -33.43107, "Providencia: 3",
    options = popupOptions(closeButton = T))
```


Column {data-width=400}
-----------------------------------------------------------------------

> Nota: El número de personas capacitadas está actualizado al 10 de Mayo del 2021.El número de personas capacitadas está actualizado al 10 de Mayo del 2021.El número de personas capacitadas está actualizado al 10 de Mayo del 2021.



Hurto{data-navmenu=Delito_2020}
===============================================

Column {data-width=600}
-----------------------------------------------------------------------

### Frecuencia (2020)

```{r fig.align='center'}
Hurto <- read_xlsx("datos/Del_base2.xlsx",sheet=3)
comunas_RM <- read_sf(dsn = "datos/limites_comunas_RM/RM.shp")
colnames(comunas_RM)[6]<-"COD_COMUNA"
colnames(comunas_RM)[7]<-"COMUNA"
data_RM3 <- comunas_RM %>% left_join(Hurto, by = "COMUNA")

paleta_colores <- colorNumeric(palette = "Reds", domain = comunas_RM$a2020)

data_RM3 %>% leaflet() %>%
  addPolygons(weight = 1, fillColor = ~paleta_colores(a2020), 
              fillOpacity = 1, 
              label = ~paste0(COMUNA,": ", round(a2020,1)),
              highlight = highlightOptions(weight = 5, 
                                           color = "orange",
                                           bringToFront = TRUE))%>%
  addPopups(-70.6653, -33.4513, "Santiago: 3565",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.60454, -33.43107, "Providencia: 2235",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.5833, -33.5333, "La Florida: 2488",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.55, -33.4117, "Las Condes: 1911",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.575, -33.3833, "Vitacura: 571",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.3686900, -33.2990800, "Lo Barnechea: 508",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.7667, -33.5167, "Maipú: 1303",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.57577, -33.61169, "Puente Alto: 1699",
    options = popupOptions(closeButton = T))
```


Column {data-width=400}
-----------------------------------------------------------------------

> Nota: El número de personas capacitadas está actualizado al 10 de Mayo del 2021.



Robo con violencia o intimidación{data-navmenu=Delito_2020}
===============================================

Column {data-width=600}
-----------------------------------------------------------------------

### Frecuencia (2020)

```{r fig.align='center'}
Robo_Violencia <- read_xlsx("datos/Del_base2.xlsx",sheet=4)
comunas_RM <- read_sf(dsn = "datos/limites_comunas_RM/RM.shp")
colnames(comunas_RM)[6]<-"COD_COMUNA"
colnames(comunas_RM)[7]<-"COMUNA"
data_RM4 <- comunas_RM %>% left_join(Robo_Violencia, by = "COMUNA")

paleta_colores <- colorNumeric(palette = "Reds", domain = comunas_RM$a2020)

data_RM4 %>% leaflet() %>%
  addPolygons(weight = 1, fillColor = ~paleta_colores(a2020), 
              fillOpacity = 1, 
              label = ~paste0(COMUNA,": ", round(a2020,1)),
              highlight = highlightOptions(weight = 5, 
                                           color = "orange",
                                           bringToFront = TRUE))%>%
  addPopups(-70.6653, -33.4513, "Santiago: 4310",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.7667, -33.5167, "Maipú: 3015",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.57577, -33.61169, "Puente Alto: 2629",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.7, -33.5833, "San Bernardo: 2436",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.60454, -33.43107, "Providencia: 863",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.55, -33.4117, "Las Condes: 421",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.575, -33.3833, "Vitacura: 333",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.3686900, -33.2990800, "Lo Barnechea: 97",
    options = popupOptions(closeButton = T))
```


Column {data-width=400}
-----------------------------------------------------------------------

> Nota: El número de personas capacitadas está actualizado al 10 de Mayo del 2021.


Robo con sorpresa {data-navmenu=Delito_2020}
===============================================

Column {data-width=600}
-----------------------------------------------------------------------

### Frecuencia (2020)

```{r fig.align='center'}
Robo_sorpresa <- read_xlsx("datos/Del_base2.xlsx",sheet=5)
comunas_RM <- read_sf(dsn = "datos/limites_comunas_RM/RM.shp")
colnames(comunas_RM)[6]<-"COD_COMUNA"
colnames(comunas_RM)[7]<-"COMUNA"
data_RM5 <- comunas_RM %>% left_join(Robo_sorpresa, by = "COMUNA")

paleta_colores <- colorNumeric(palette = "Reds", domain = comunas_RM$a2020)

data_RM5 %>% leaflet() %>%
  addPolygons(weight = 1, fillColor = ~paleta_colores(a2020), 
              fillOpacity = 1, 
              label = ~paste0(COMUNA,": ", round(a2020,1)),
              highlight = highlightOptions(weight = 5, 
                                           color = "orange",
                                           bringToFront = TRUE))%>%
  addPopups(-70.6653, -33.4513, "Santiago: 2776",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.6333, -33.4083, "Recoleta: 704",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.57577, -33.61169, "Puente Alto: 540",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.60454, -33.43107, "Providencia: 582",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.55, -33.4117, "Las Condes: 264",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.575, -33.3833, "Vitacura: 65",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.3686900, -33.2990800, "Lo Barnechea: 29",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.7, -33.4667, "Estación Central: 1268",
    options = popupOptions(closeButton = T))
```


Column {data-width=400}
-----------------------------------------------------------------------

> Nota: El número de personas capacitadas está actualizado al 10 de Mayo del 2021.


Violencia intrafamiliar {data-navmenu=Delito_2020}
===============================================

Column {data-width=600}
-----------------------------------------------------------------------

### Frecuencia (2020)

```{r fig.align='center'}
Violencia <- read_xlsx("datos/Del_base2.xlsx",sheet=6)
comunas_RM <- read_sf(dsn = "datos/limites_comunas_RM/RM.shp")
colnames(comunas_RM)[6]<-"COD_COMUNA"
colnames(comunas_RM)[7]<-"COMUNA"
data_RM6 <- comunas_RM %>% left_join(Violencia, by = "COMUNA")

paleta_colores <- colorNumeric(palette = "Reds", domain = comunas_RM$a2020)

data_RM6 %>% leaflet() %>%
  addPolygons(weight = 1, fillColor = ~paleta_colores(a2020), 
              fillOpacity = 1, 
              label = ~paste0(COMUNA,": ", round(a2020,1)),
              highlight = highlightOptions(weight = 5, 
                                           color = "orange",
                                           bringToFront = TRUE))%>%
  addPopups(-70.57577, -33.61169, "Puente Alto: 3932",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.7667, -33.5167, "Maipú: 2563",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.7, -33.5833, "San Bernardo: 2215",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.55, -33.4117, "Las Condes: 627",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.575, -33.3833, "Vitacura: 142",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.3686900, -33.2990800, "Lo Barnechea: 299",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.6653, -33.4513, "Santiago: 1686",
    options = popupOptions(closeButton = T))%>%
  addPopups(-70.5833, -33.5333, "La Florida: 1775",
    options = popupOptions(closeButton = T))
```

Column {data-width=400}
-----------------------------------------------------------------------

> Nota: El número de personas capacitadas está actualizado al 10 de Mayo del 2021.
